<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ingress-nginx on Hsinyv Ku's Space</title><link>https://blog.gxy.ink/tags/ingress-nginx/</link><description>Recent content in ingress-nginx on Hsinyv Ku's Space</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>Â© 2021 Powered By Hsinyv Ku :: &lt;a href="https://beian.miit.gov.cn/" target="_blank">èµ£ICPå¤‡20002368å·-1&lt;/a></copyright><lastBuildDate>Thu, 29 Jul 2021 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.gxy.ink/tags/ingress-nginx/index.xml" rel="self" type="application/rss+xml"/><item><title>åœ¨ k8s ä¸Šä½¿ç”¨å¤–éƒ¨è®¤è¯</title><link>https://blog.gxy.ink/posts/use-external-auth-on-k8s/</link><pubDate>Thu, 29 Jul 2021 00:00:00 +0000</pubDate><guid>https://blog.gxy.ink/posts/use-external-auth-on-k8s/</guid><description>ä¸€ã€JSON Web Token 1. ä»€ä¹ˆæ˜¯ JWT ï¼Ÿ è¯¦ç»†å†…å®¹è¯·å‚è€ƒ RFC 7519ã€‚ JWT æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç”¨äºå°†å„æ–¹ä¹‹é—´çš„ä¿¡æ¯ä½œä¸º JSON å¯¹è±¡è¿›è¡Œå®‰å…¨åœ°ä¼ è¾“çš„ç´§å‡‘ä¸”è‡ªåŒ…</description><content>&lt;h2 id="ä¸€json-web-token">ä¸€ã€JSON Web Token&lt;/h2>
&lt;h3 id="1-ä»€ä¹ˆæ˜¯-jwt-">1. ä»€ä¹ˆæ˜¯ JWT ï¼Ÿ&lt;/h3>
&lt;ul>
&lt;li>è¯¦ç»†å†…å®¹è¯·å‚è€ƒ &lt;a href="https://datatracker.ietf.org/doc/html/rfc7519">RFC 7519&lt;/a>ã€‚&lt;/li>
&lt;li>&lt;strong>JWT&lt;/strong> æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç”¨äº&lt;strong>å°†å„æ–¹ä¹‹é—´çš„ä¿¡æ¯ä½œä¸º JSON å¯¹è±¡è¿›è¡Œå®‰å…¨åœ°ä¼ è¾“&lt;/strong>çš„ç´§å‡‘ä¸”è‡ªåŒ…å«çš„æ–¹å¼ã€‚&lt;/li>
&lt;li>ç”±äºä¿¡æ¯è¢«æ•°å­—ç­¾åï¼Œå› æ­¤å¯ä»¥éªŒè¯å’Œä¿¡ä»»ã€‚&lt;/li>
&lt;li>å¯ä»¥ä½¿ç”¨ HMACã€RSA æˆ– ECDSA ç®—æ³•å¯¹ &lt;strong>JWT&lt;/strong> è¿›è¡Œ&lt;strong>ç­¾å&lt;/strong>ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="2-ä»€ä¹ˆæ—¶å€™è¯¥ç”¨å®ƒ">2. ä»€ä¹ˆæ—¶å€™è¯¥ç”¨å®ƒï¼Ÿ&lt;/h3>
&lt;ul>
&lt;li>è¯·æ±‚é‰´æƒ&lt;/li>
&lt;li>ä¿¡æ¯ä¼ è¾“ï¼ˆå¯ä»¥éªŒè¯å†…å®¹æ˜¯å¦è¢«ç¯¡æ”¹ï¼‰&lt;/li>
&lt;/ul>
&lt;h3 id="3-jwt-çš„ç»“æ„">3. JWT çš„ç»“æ„&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>ä¸‰ä¸ªç»„æˆéƒ¨åˆ†&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Header&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="color:#f92672">&amp;#34;alg&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;HS256&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;typ&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;JWT&amp;#34;&lt;/span>
}
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Payload&lt;/p>
&lt;ul>
&lt;li>Registered claims (éå¼ºåˆ¶æ€§çš„)ï¼Œå¦‚ &lt;code>iss&lt;/code>ã€&lt;code>exp&lt;/code> å’Œ &lt;code>sub&lt;/code> ç­‰ã€‚&lt;/li>
&lt;li>Public claims&lt;/li>
&lt;li>Private claims&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="color:#f92672">&amp;#34;exp&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">1627544720&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;sub&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;1234567890&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;username&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;6109119115&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;role&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;admin&amp;#34;&lt;/span>
}
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Signature&lt;/p>
&lt;p>ä»¥ HMAC SHA256 ç®—æ³•ä¸ºä¾‹ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>HMACSHA256(base64UrlEncode(header) + &amp;quot;.&amp;quot; + base64UrlEncode(payload), secret)
&lt;/code>&lt;/pre>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>ä¸€ä¸ªæœªç»è§£æçš„ JWT çœ‹èµ·æ¥åƒè¿™æ ·ï¼š&lt;code>xxxxx.yyyyy.zzzzz&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨ä½¿ç”¨ Bearer æ¨¡å¼çš„ Authorization è¯·æ±‚å¤´ä¸­ï¼š&lt;code>Authorization: Bearer xxxxx.yyyyy.zzzzz&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="4-ä½¿ç”¨-jwt-çš„åº”ç”¨è¯·æ±‚æµç¨‹">4. ä½¿ç”¨ JWT çš„åº”ç”¨è¯·æ±‚æµç¨‹&lt;/h3>
&lt;p>&lt;img src="https://blog.gxy.ink/images/jwt-request.png" alt="image-20210729161426928">&lt;/p>
&lt;h2 id="äºŒå¤–éƒ¨è®¤è¯å®è·µ">äºŒã€å¤–éƒ¨è®¤è¯å®è·µ&lt;/h2>
&lt;h3 id="1-è¯·æ±‚æµé‡è·¯å¾„">1. è¯·æ±‚æµé‡è·¯å¾„&lt;/h3>
&lt;p>&lt;img src="https://blog.gxy.ink/images/request-use-external-auth.png" alt="image-20210730164202783">&lt;/p>
&lt;h3 id="2-åœ¨-rancher-ä¸Šå®æˆ˜">2. åœ¨ Rancher ä¸Šå®æˆ˜&lt;/h3>
&lt;p>GitHub ä»“åº“ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://github.com/kuhsinyv/external-auth-server">https://github.com/kuhsinyv/external-auth-server&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://github.com/kuhsinyv/external-auth-client">https://github.com/kuhsinyv/external-auth-client&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="1-ç¼–å†™-auth-server">(1) ç¼–å†™ Auth Server&lt;/h4>
&lt;p>a. å…ˆçœ‹è·¯ç”±å®šä¹‰ï¼ˆä½¿ç”¨ &lt;code>Gin&lt;/code>ï¼‰ï¼Œå…¶ä¸­ &lt;code>/api/v1/token&lt;/code> ç”¨ä»¥è·å– tokenï¼Œ&lt;code>/api/v1/auth&lt;/code> ç”¨ä»¥éªŒè¯ tokenã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">router&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> (
&lt;span style="color:#e6db74">&amp;#34;eas/internal/api/auth&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;eas/internal/middlewares/jwt&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;github.com/gin-gonic/gin&amp;#34;&lt;/span>
)
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">GinRouter&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">Engine&lt;/span>
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">init&lt;/span>() {
&lt;span style="color:#a6e22e">GinRouter&lt;/span> = &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">Default&lt;/span>()
&lt;span style="color:#a6e22e">apiV1&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">GinRouter&lt;/span>.&lt;span style="color:#a6e22e">Group&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;/api/v1&amp;#34;&lt;/span>)
{
&lt;span style="color:#a6e22e">apiV1&lt;/span>.&lt;span style="color:#a6e22e">GET&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;/token&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">auth&lt;/span>.&lt;span style="color:#a6e22e">GetToken&lt;/span>)
&lt;span style="color:#a6e22e">apiV1&lt;/span>.&lt;span style="color:#a6e22e">Any&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;/auth&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">jwt&lt;/span>.&lt;span style="color:#a6e22e">JWT&lt;/span>(), &lt;span style="color:#a6e22e">auth&lt;/span>.&lt;span style="color:#a6e22e">Auth&lt;/span>)
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>b. &lt;code>/api/v1/token&lt;/code> æ¥å£çš„å…·ä½“å®ç°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">auth&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> (
&lt;span style="color:#e6db74">&amp;#34;eas/tools/jwt&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;github.com/gin-gonic/gin&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;log&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;time&amp;#34;&lt;/span>
)
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">GetToken&lt;/span>(&lt;span style="color:#a6e22e">c&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>) {
&lt;span style="color:#66d9ef">if&lt;/span> !(&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">Query&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;username&amp;#34;&lt;/span>) &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;6109119115&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">Query&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;password&amp;#34;&lt;/span>) &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;123&amp;#34;&lt;/span>) {
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">JSON&lt;/span>(&lt;span style="color:#ae81ff">403&lt;/span>, &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">H&lt;/span>{
&lt;span style="color:#e6db74">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">1&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;è´¦å·æˆ–å¯†ç é”™è¯¯&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">nil&lt;/span>,
})
&lt;span style="color:#66d9ef">return&lt;/span>
}
&lt;span style="color:#a6e22e">claims&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#66d9ef">map&lt;/span>[&lt;span style="color:#66d9ef">string&lt;/span>]&lt;span style="color:#66d9ef">interface&lt;/span>{}{
&lt;span style="color:#e6db74">&amp;#34;exp&amp;#34;&lt;/span>: &lt;span style="color:#a6e22e">time&lt;/span>.&lt;span style="color:#a6e22e">Now&lt;/span>().&lt;span style="color:#a6e22e">Add&lt;/span>(&lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#a6e22e">time&lt;/span>.&lt;span style="color:#a6e22e">Hour&lt;/span>).&lt;span style="color:#a6e22e">Unix&lt;/span>(),
&lt;span style="color:#e6db74">&amp;#34;username&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;6109119115&amp;#34;&lt;/span>,
}
&lt;span style="color:#a6e22e">tokenString&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">jwt&lt;/span>.&lt;span style="color:#a6e22e">GenerateToken&lt;/span>(&lt;span style="color:#a6e22e">claims&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">JSON&lt;/span>(&lt;span style="color:#ae81ff">500&lt;/span>, &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">H&lt;/span>{
&lt;span style="color:#e6db74">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">2&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;ç”Ÿæˆ token å¤±è´¥&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">nil&lt;/span>,
})
&lt;span style="color:#a6e22e">log&lt;/span>.&lt;span style="color:#a6e22e">Println&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;api/auth: failed to generate token string: &amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span>)
&lt;span style="color:#66d9ef">return&lt;/span>
}
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">JSON&lt;/span>(&lt;span style="color:#ae81ff">200&lt;/span>, &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">H&lt;/span>{
&lt;span style="color:#e6db74">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;è·å– token æˆåŠŸ&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">H&lt;/span>{
&lt;span style="color:#e6db74">&amp;#34;token&amp;#34;&lt;/span>: &lt;span style="color:#a6e22e">tokenString&lt;/span>,
},
})
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>c. è·å–ã€è§£æ token çš„ä¸­é—´ä»¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">jwt&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> (
&lt;span style="color:#e6db74">&amp;#34;eas/tools/jwt&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;github.com/gin-gonic/gin&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;net/url&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;strings&amp;#34;&lt;/span>
)
&lt;span style="color:#75715e">// getTokenString ä» Request Header ä¸­çš„ Authorization è·å– JWTï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™ä» Query Params ä¸­è·å–ã€‚
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">getTokenString&lt;/span>(&lt;span style="color:#a6e22e">c&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>) &lt;span style="color:#66d9ef">string&lt;/span> {
&lt;span style="color:#a6e22e">tokenString&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">Request&lt;/span>.&lt;span style="color:#a6e22e">Header&lt;/span>.&lt;span style="color:#a6e22e">Get&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Authorization&amp;#34;&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">tokenString&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> {
&lt;span style="color:#a6e22e">queryParamsToken&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">Query&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;token&amp;#34;&lt;/span>)
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#66d9ef">error&lt;/span>
&lt;span style="color:#a6e22e">tokenString&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">url&lt;/span>.&lt;span style="color:#a6e22e">QueryUnescape&lt;/span>(&lt;span style="color:#a6e22e">queryParamsToken&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>
}
}
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">tokenString&lt;/span>
}
&lt;span style="color:#75715e">// JWT è®¤è¯ä¸­é—´ä»¶
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">JWT&lt;/span>() &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">HandlerFunc&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">func&lt;/span>(&lt;span style="color:#a6e22e">c&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>) {
&lt;span style="color:#a6e22e">tokenString&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">getTokenString&lt;/span>(&lt;span style="color:#a6e22e">c&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">tokenString&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> {
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">AbortWithStatusJSON&lt;/span>(&lt;span style="color:#ae81ff">401&lt;/span>, &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">H&lt;/span>{
&lt;span style="color:#e6db74">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">1&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;è¯·é™„å¸¦ jwt åœ¨ Request Headers[Authorization] æˆ– Query Params[token] å†…&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">nil&lt;/span>,
})
&lt;span style="color:#66d9ef">return&lt;/span>
}
&lt;span style="color:#a6e22e">tokenStringSlice&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">strings&lt;/span>.&lt;span style="color:#a6e22e">Split&lt;/span>(&lt;span style="color:#a6e22e">tokenString&lt;/span>, &lt;span style="color:#e6db74">&amp;#34; &amp;#34;&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> len(&lt;span style="color:#a6e22e">tokenStringSlice&lt;/span>) &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span> {
&lt;span style="color:#a6e22e">tokenString&lt;/span> = &lt;span style="color:#a6e22e">tokenStringSlice&lt;/span>[len(&lt;span style="color:#a6e22e">tokenStringSlice&lt;/span>)&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>]
}
&lt;span style="color:#a6e22e">claims&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">jwt&lt;/span>.&lt;span style="color:#a6e22e">ParseTokenWithMapClaims&lt;/span>(&lt;span style="color:#a6e22e">tokenString&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">AbortWithStatusJSON&lt;/span>(&lt;span style="color:#ae81ff">401&lt;/span>, &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">H&lt;/span>{
&lt;span style="color:#e6db74">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">2&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;éæ³•çš„ token&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">nil&lt;/span>,
})
&lt;span style="color:#66d9ef">return&lt;/span>
}
&lt;span style="color:#a6e22e">username&lt;/span>, &lt;span style="color:#a6e22e">ok&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> (&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">claims&lt;/span>)[&lt;span style="color:#e6db74">&amp;#34;username&amp;#34;&lt;/span>].(&lt;span style="color:#66d9ef">string&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> !&lt;span style="color:#a6e22e">ok&lt;/span> {
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">AbortWithStatusJSON&lt;/span>(&lt;span style="color:#ae81ff">401&lt;/span>, &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">H&lt;/span>{
&lt;span style="color:#e6db74">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">3&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;éæ³•çš„ payload&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">nil&lt;/span>,
})
&lt;span style="color:#66d9ef">return&lt;/span>
}
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">Set&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;username&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">username&lt;/span>)
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">Next&lt;/span>()
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>d. å°†è§£æå‡ºæ¥çš„æ•°æ®æ·»åŠ åˆ°çº¦å®šçš„ Response Headers ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">auth&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#e6db74">&amp;#34;github.com/gin-gonic/gin&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">Auth&lt;/span>(&lt;span style="color:#a6e22e">c&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>) {
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">username&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">GetString&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;username&amp;#34;&lt;/span>); &lt;span style="color:#a6e22e">username&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> {
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">JSON&lt;/span>(&lt;span style="color:#ae81ff">401&lt;/span>, &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">H&lt;/span>{
&lt;span style="color:#e6db74">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">1&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;ç”¨æˆ·æœªè®¤è¯&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">nil&lt;/span>,
})
} &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">Writer&lt;/span>.&lt;span style="color:#a6e22e">Header&lt;/span>().&lt;span style="color:#a6e22e">Set&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Username&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">username&lt;/span>)
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">JSON&lt;/span>(&lt;span style="color:#ae81ff">200&lt;/span>, &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">H&lt;/span>{
&lt;span style="color:#e6db74">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;èº«ä»½è®¤è¯æˆåŠŸ&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">nil&lt;/span>,
})
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="2-ç¼–å†™-auth-client">(2) ç¼–å†™ Auth Client&lt;/h4>
&lt;p>a. å…ˆçœ‹è·¯ç”±å®šä¹‰ï¼ˆä½¿ç”¨ &lt;code>Gin&lt;/code>ï¼‰ï¼Œ&lt;code>/api/v1/greeting&lt;/code> å°†æ ¹æ®å¤–éƒ¨è®¤è¯ç»“æœæ¥è¿”å›ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">router&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> (
&lt;span style="color:#e6db74">&amp;#34;eac/internal/api/greeter&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;github.com/gin-gonic/gin&amp;#34;&lt;/span>
)
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">GinRouter&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">Engine&lt;/span>
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">init&lt;/span>() {
&lt;span style="color:#a6e22e">GinRouter&lt;/span> = &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">Default&lt;/span>()
&lt;span style="color:#a6e22e">apiV1&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">GinRouter&lt;/span>.&lt;span style="color:#a6e22e">Group&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;/api/v1&amp;#34;&lt;/span>)
{
&lt;span style="color:#a6e22e">apiV1&lt;/span>.&lt;span style="color:#a6e22e">GET&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;/greeting&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">greeter&lt;/span>.&lt;span style="color:#a6e22e">Greeting&lt;/span>)
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>b. &lt;code>/api/v1/greeting&lt;/code> å…·ä½“å®ç°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">greeter&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> (
&lt;span style="color:#e6db74">&amp;#34;github.com/gin-gonic/gin&amp;#34;&lt;/span>
)
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">Greeting&lt;/span>(&lt;span style="color:#a6e22e">c&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>) {
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">username&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">GetHeader&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Username&amp;#34;&lt;/span>); &lt;span style="color:#a6e22e">username&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> {
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">JSON&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>, &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">H&lt;/span>{
&lt;span style="color:#e6db74">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">1&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;è·å– Request Headers Username å¤±è´¥&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">nil&lt;/span>,
})
} &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">JSON&lt;/span>(&lt;span style="color:#ae81ff">200&lt;/span>, &lt;span style="color:#a6e22e">gin&lt;/span>.&lt;span style="color:#a6e22e">H&lt;/span>{
&lt;span style="color:#e6db74">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Welcome, &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#a6e22e">username&lt;/span>,
&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">nil&lt;/span>,
})
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-éƒ¨ç½²-rancher-å·¥ä½œè´Ÿè½½">(3) éƒ¨ç½² Rancher å·¥ä½œè´Ÿè½½&lt;/h4>
&lt;p>a. Auth Server&lt;/p>
&lt;p>&lt;img src="https://blog.gxy.ink/images/eas-workload.png" alt="Auth Server">&lt;/p>
&lt;p>b. Auth Client&lt;/p>
&lt;p>&lt;img src="https://blog.gxy.ink/images/eac-workload.png" alt="Auth Client">&lt;/p>
&lt;h4 id="4-é…ç½®-ingress-rancher-è´Ÿè½½å‡è¡¡">(4) é…ç½® Ingress (Rancher è´Ÿè½½å‡è¡¡)&lt;/h4>
&lt;p>a. Auth Server&lt;/p>
&lt;p>&lt;img src="https://blog.gxy.ink/images/eas-ingress.png" alt="Auth Server">&lt;/p>
&lt;p>b. Auth Client&lt;/p>
&lt;p>ğŸŒŸ åœ¨ Auth Client çš„ Ingress é…ç½®ä¸­æ·»åŠ å¦‚ä¸‹æ³¨é‡Šã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yml" data-lang="yml">&lt;span style="color:#f92672">nginx.ingress.kubernetes.io/auth-response-headers&lt;/span>: &lt;span style="color:#ae81ff">Username&lt;/span>
&lt;span style="color:#f92672">nginx.ingress.kubernetes.io/auth-url&lt;/span>: &lt;span style="color:#ae81ff">https://eas.example.com/api/v1/auth&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.gxy.ink/images/eac-ingress.png" alt="Auth Clinet">&lt;/p>
&lt;h4 id="5-æµ‹è¯•">(5) æµ‹è¯•&lt;/h4>
&lt;p>a. è·å– token&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">curl --location --request GET &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span>&lt;span style="color:#e6db74">&amp;#39;https://eas.example.com/api/v1/token?username=6109119115&amp;amp;password=123&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="color:#f92672">&amp;#34;data&amp;#34;&lt;/span>: {
&lt;span style="color:#f92672">&amp;#34;token&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2Mjc3NDgxOTQsInVzZXJuYW1lIjoiNjEwOTExOTExNSJ9.zTynNcdUjWnbGXsCs1lZZsVhMpwiUaz6NBYsW9jK41A&amp;#34;&lt;/span>
},
&lt;span style="color:#f92672">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;è·å– token æˆåŠŸ&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>b. éªŒè¯ Auth Server ä½œç”¨&lt;/p>
&lt;p>é™„å¸¦ JWT&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">curl --location --request GET &lt;span style="color:#e6db74">&amp;#39;https://eac.example.com/api/v1/greeting&amp;#39;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span>--header &lt;span style="color:#e6db74">&amp;#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2Mjc3NDgxOTQsInVzZXJuYW1lIjoiNjEwOTExOTExNSJ9.zTynNcdUjWnbGXsCs1lZZsVhMpwiUaz6NBYsW9jK41A&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="color:#f92672">&amp;#34;data&amp;#34;&lt;/span>: &lt;span style="color:#66d9ef">null&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Welcome, 6109119115&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">0&lt;/span>
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœªé™„å¸¦ JWT&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">curl --location --request GET &lt;span style="color:#e6db74">&amp;#39;https://eac.example.com/api/v1/greeting&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-html" data-lang="html">&amp;lt;&lt;span style="color:#f92672">html&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">head&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">title&lt;/span>&amp;gt;500 Internal Server Error&amp;lt;/&lt;span style="color:#f92672">title&lt;/span>&amp;gt;
&amp;lt;/&lt;span style="color:#f92672">head&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">body&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">center&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">h1&lt;/span>&amp;gt;500 Internal Server Error&amp;lt;/&lt;span style="color:#f92672">h1&lt;/span>&amp;gt;
&amp;lt;/&lt;span style="color:#f92672">center&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">hr&lt;/span>&amp;gt;
&amp;lt;&lt;span style="color:#f92672">center&lt;/span>&amp;gt;nginx&amp;lt;/&lt;span style="color:#f92672">center&lt;/span>&amp;gt;
&amp;lt;/&lt;span style="color:#f92672">body&lt;/span>&amp;gt;
&amp;lt;/&lt;span style="color:#f92672">html&lt;/span>&amp;gt;
&lt;/code>&lt;/pre>&lt;/div></content></item></channel></rss>