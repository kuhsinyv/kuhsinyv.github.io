<!doctype html><html lang=en>
<head>
<title>åœ¨ k8s ä¸Šä½¿ç”¨å¤–éƒ¨è®¤è¯ :: Hsinyv Ku's Space</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="ä½¿ç”¨ ingress-nginx å’Œ Auth Service è®¤è¯è¯·æ±‚">
<meta name=keywords content="ingress,nginx,k8s,è®¤è¯,jwt,go">
<meta name=robots content="noodp">
<link rel=canonical href=https://blog.gxy.ink/posts/use-external-auth-on-k8s/>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q8X6Z2DL16"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Q8X6Z2DL16',{anonymize_ip:!1})}</script>
<link rel=stylesheet href=https://blog.gxy.ink/assets/style.css>
<link rel=apple-touch-icon href=https://blog.gxy.ink/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://blog.gxy.ink/img/favicon/orange.png>
<meta name=twitter:card content="summary">
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="åœ¨ k8s ä¸Šä½¿ç”¨å¤–éƒ¨è®¤è¯">
<meta property="og:description" content="ä½¿ç”¨ ingress-nginx å’Œ Auth Service è®¤è¯è¯·æ±‚">
<meta property="og:url" content="https://blog.gxy.ink/posts/use-external-auth-on-k8s/">
<meta property="og:site_name" content="Hsinyv Ku's Space">
<meta property="og:image" content="https://blog.gxy.ink/images/k8s-ingress-nginx.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:section" content="éšç¬”">
<meta property="article:published_time" content="2021-07-29 00:00:00 +0000 UTC">
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
</head>
<body class=orange>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
Hsinyv Ku
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/posts>Posts</a></li>
<li><a href=/tags>Tags</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/posts>Posts</a></li>
<li><a href=/tags>Tags</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://blog.gxy.ink/posts/use-external-auth-on-k8s/>åœ¨ k8s ä¸Šä½¿ç”¨å¤–éƒ¨è®¤è¯</a></h1>
<div class=post-meta>
<span class=post-date>
2021-07-29
[Updated: 2022-01-13]
</span>
<span class=post-author>:: Hsinyv Ku</span>
<span class=post-reading-time>:: 3 min read (1146 words)</span>
<span class=post-reads>
:: reads <span id=busuanzi_value_page_pv></span>
</span>
</div>
<span class=post-tags>
#<a href=https://blog.gxy.ink/tags/kubernetes/>Kubernetes</a>&nbsp;
#<a href=https://blog.gxy.ink/tags/ingress-nginx/>ingress-nginx</a>&nbsp;
#<a href=https://blog.gxy.ink/tags/jwt/>JWT</a>&nbsp;
#<a href=https://blog.gxy.ink/tags/go/>Go</a>&nbsp;
#<a href=https://blog.gxy.ink/tags/gin/>Gin</a>&nbsp;
</span>
<img src=https://blog.gxy.ink/images/k8s-ingress-nginx.png class=post-cover alt="åœ¨ k8s ä¸Šä½¿ç”¨å¤–éƒ¨è®¤è¯" title="Cover Image">
<div class=table-of-contents>
<h2>
Table of Contents
</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#ä¸€json-web-token>ä¸€ã€JSON Web Token</a>
<ul>
<li><a href=#1-ä»€ä¹ˆæ˜¯-jwt->1. ä»€ä¹ˆæ˜¯ JWT ï¼Ÿ</a></li>
<li><a href=#2-ä»€ä¹ˆæ—¶å€™è¯¥ç”¨å®ƒ>2. ä»€ä¹ˆæ—¶å€™è¯¥ç”¨å®ƒï¼Ÿ</a></li>
<li><a href=#3-jwt-çš„ç»“æ„>3. JWT çš„ç»“æ„</a></li>
<li><a href=#4-ä½¿ç”¨-jwt-çš„åº”ç”¨è¯·æ±‚æµç¨‹>4. ä½¿ç”¨ JWT çš„åº”ç”¨è¯·æ±‚æµç¨‹</a></li>
</ul>
</li>
<li><a href=#äºŒå¤–éƒ¨è®¤è¯å®è·µ>äºŒã€å¤–éƒ¨è®¤è¯å®è·µ</a>
<ul>
<li><a href=#1-è¯·æ±‚æµé‡è·¯å¾„>1. è¯·æ±‚æµé‡è·¯å¾„</a></li>
<li><a href=#2-åœ¨-rancher-ä¸Šå®æˆ˜>2. åœ¨ Rancher ä¸Šå®æˆ˜</a></li>
</ul>
</li>
</ul>
</nav>
</div>
<div class=post-content><div>
<h2 id=ä¸€json-web-token>ä¸€ã€JSON Web Token<a href=#ä¸€json-web-token class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h3 id=1-ä»€ä¹ˆæ˜¯-jwt->1. ä»€ä¹ˆæ˜¯ JWT ï¼Ÿ<a href=#1-ä»€ä¹ˆæ˜¯-jwt- class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>è¯¦ç»†å†…å®¹è¯·å‚è€ƒ <a href=https://datatracker.ietf.org/doc/html/rfc7519>RFC 7519</a>ã€‚</li>
<li><strong>JWT</strong> æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç”¨äº<strong>å°†å„æ–¹ä¹‹é—´çš„ä¿¡æ¯ä½œä¸º JSON å¯¹è±¡è¿›è¡Œå®‰å…¨åœ°ä¼ è¾“</strong>çš„ç´§å‡‘ä¸”è‡ªåŒ…å«çš„æ–¹å¼ã€‚</li>
<li>ç”±äºä¿¡æ¯è¢«æ•°å­—ç­¾åï¼Œå› æ­¤å¯ä»¥éªŒè¯å’Œä¿¡ä»»ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨ HMACã€RSA æˆ– ECDSA ç®—æ³•å¯¹ <strong>JWT</strong> è¿›è¡Œ<strong>ç­¾å</strong>ã€‚</li>
</ul>
<h3 id=2-ä»€ä¹ˆæ—¶å€™è¯¥ç”¨å®ƒ>2. ä»€ä¹ˆæ—¶å€™è¯¥ç”¨å®ƒï¼Ÿ<a href=#2-ä»€ä¹ˆæ—¶å€™è¯¥ç”¨å®ƒ class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>è¯·æ±‚é‰´æƒ</li>
<li>ä¿¡æ¯ä¼ è¾“ï¼ˆå¯ä»¥éªŒè¯å†…å®¹æ˜¯å¦è¢«ç¯¡æ”¹ï¼‰</li>
</ul>
<h3 id=3-jwt-çš„ç»“æ„>3. JWT çš„ç»“æ„<a href=#3-jwt-çš„ç»“æ„ class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>
<p>ä¸‰ä¸ªç»„æˆéƒ¨åˆ†</p>
<ul>
<li>
<p>Header</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;alg&#34;</span>: <span style=color:#e6db74>&#34;HS256&#34;</span>,
  <span style=color:#f92672>&#34;typ&#34;</span>: <span style=color:#e6db74>&#34;JWT&#34;</span>
}
</code></pre></div></li>
<li>
<p>Payload</p>
<ul>
<li>Registered claims (éå¼ºåˆ¶æ€§çš„)ï¼Œå¦‚ <code>iss</code>ã€<code>exp</code> å’Œ <code>sub</code> ç­‰ã€‚</li>
<li>Public claims</li>
<li>Private claims</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;exp&#34;</span>: <span style=color:#ae81ff>1627544720</span>,
  <span style=color:#f92672>&#34;sub&#34;</span>: <span style=color:#e6db74>&#34;1234567890&#34;</span>,
  <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;6109119115&#34;</span>,
  <span style=color:#f92672>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;admin&#34;</span>
}
</code></pre></div></li>
<li>
<p>Signature</p>
<p>ä»¥ HMAC SHA256 ç®—æ³•ä¸ºä¾‹ï¼š</p>
<pre tabindex=0><code>HMACSHA256(base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload), secret)
</code></pre></li>
</ul>
</li>
<li>
<p>ä¸€ä¸ªæœªç»è§£æçš„ JWT çœ‹èµ·æ¥åƒè¿™æ ·ï¼š<code>xxxxx.yyyyy.zzzzz</code>ã€‚</p>
</li>
<li>
<p>åœ¨ä½¿ç”¨ Bearer æ¨¡å¼çš„ Authorization è¯·æ±‚å¤´ä¸­ï¼š<code>Authorization: Bearer xxxxx.yyyyy.zzzzz</code>ã€‚</p>
</li>
</ul>
<h3 id=4-ä½¿ç”¨-jwt-çš„åº”ç”¨è¯·æ±‚æµç¨‹>4. ä½¿ç”¨ JWT çš„åº”ç”¨è¯·æ±‚æµç¨‹<a href=#4-ä½¿ç”¨-jwt-çš„åº”ç”¨è¯·æ±‚æµç¨‹ class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p><img src=/images/jwt-request.png alt=image-20210729161426928></p>
<h2 id=äºŒå¤–éƒ¨è®¤è¯å®è·µ>äºŒã€å¤–éƒ¨è®¤è¯å®è·µ<a href=#äºŒå¤–éƒ¨è®¤è¯å®è·µ class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h3 id=1-è¯·æ±‚æµé‡è·¯å¾„>1. è¯·æ±‚æµé‡è·¯å¾„<a href=#1-è¯·æ±‚æµé‡è·¯å¾„ class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p><img src=/images/request-use-external-auth.png alt=image-20210730164202783></p>
<h3 id=2-åœ¨-rancher-ä¸Šå®æˆ˜>2. åœ¨ Rancher ä¸Šå®æˆ˜<a href=#2-åœ¨-rancher-ä¸Šå®æˆ˜ class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>GitHub ä»“åº“ï¼š</p>
<ul>
<li>
<p><a href=https://github.com/kuhsinyv/external-auth-server>https://github.com/kuhsinyv/external-auth-server</a></p>
</li>
<li>
<p><a href=https://github.com/kuhsinyv/external-auth-client>https://github.com/kuhsinyv/external-auth-client</a></p>
</li>
</ul>
<h4 id=1-ç¼–å†™-auth-server>(1) ç¼–å†™ Auth Server<a href=#1-ç¼–å†™-auth-server class=hanchor arialabel=Anchor>&#8983;</a> </h4>
<p>a. å…ˆçœ‹è·¯ç”±å®šä¹‰ï¼ˆä½¿ç”¨ <code>Gin</code>ï¼‰ï¼Œå…¶ä¸­ <code>/api/v1/token</code> ç”¨ä»¥è·å– tokenï¼Œ<code>/api/v1/auth</code> ç”¨ä»¥éªŒè¯ tokenã€‚</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>router</span>

<span style=color:#f92672>import</span> (
  <span style=color:#e6db74>&#34;eas/internal/api/auth&#34;</span>
  <span style=color:#e6db74>&#34;eas/internal/middlewares/jwt&#34;</span>
  <span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
)

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>GinRouter</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Engine</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
  <span style=color:#a6e22e>GinRouter</span> = <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Default</span>()

  <span style=color:#a6e22e>apiV1</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GinRouter</span>.<span style=color:#a6e22e>Group</span>(<span style=color:#e6db74>&#34;/api/v1&#34;</span>)
  {
    <span style=color:#a6e22e>apiV1</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/token&#34;</span>, <span style=color:#a6e22e>auth</span>.<span style=color:#a6e22e>GetToken</span>)
    <span style=color:#a6e22e>apiV1</span>.<span style=color:#a6e22e>Any</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>JWT</span>(), <span style=color:#a6e22e>auth</span>.<span style=color:#a6e22e>Auth</span>)
  }
}
</code></pre></div><p>b. <code>/api/v1/token</code> æ¥å£çš„å…·ä½“å®ç°ã€‚</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>auth</span>

<span style=color:#f92672>import</span> (
  <span style=color:#e6db74>&#34;eas/tools/jwt&#34;</span>
  <span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
  <span style=color:#e6db74>&#34;log&#34;</span>
  <span style=color:#e6db74>&#34;time&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GetToken</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
  <span style=color:#66d9ef>if</span> !(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;username&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;6109119115&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;password&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;123&#34;</span>) {
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>403</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
      <span style=color:#e6db74>&#34;status&#34;</span>:  <span style=color:#ae81ff>1</span>,
      <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;è´¦å·æˆ–å¯†ç é”™è¯¯&#34;</span>,
      <span style=color:#e6db74>&#34;data&#34;</span>:    <span style=color:#66d9ef>nil</span>,
    })

    <span style=color:#66d9ef>return</span>
  }

  <span style=color:#a6e22e>claims</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
    <span style=color:#e6db74>&#34;exp&#34;</span>:      <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>3</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Hour</span>).<span style=color:#a6e22e>Unix</span>(),
    <span style=color:#e6db74>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;6109119115&#34;</span>,
  }

  <span style=color:#a6e22e>tokenString</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>GenerateToken</span>(<span style=color:#a6e22e>claims</span>)
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>500</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
      <span style=color:#e6db74>&#34;status&#34;</span>:  <span style=color:#ae81ff>2</span>,
      <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;ç”Ÿæˆ token å¤±è´¥&#34;</span>,
      <span style=color:#e6db74>&#34;data&#34;</span>:    <span style=color:#66d9ef>nil</span>,
    })

    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;api/auth: failed to generate token string: &#34;</span>, <span style=color:#a6e22e>err</span>)

    <span style=color:#66d9ef>return</span>
  }

  <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
    <span style=color:#e6db74>&#34;status&#34;</span>:  <span style=color:#ae81ff>0</span>,
    <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;è·å– token æˆåŠŸ&#34;</span>,
    <span style=color:#e6db74>&#34;data&#34;</span>: <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
      <span style=color:#e6db74>&#34;token&#34;</span>: <span style=color:#a6e22e>tokenString</span>,
    },
  })
}
</code></pre></div><p>c. è·å–ã€è§£æ token çš„ä¸­é—´ä»¶ã€‚</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>jwt</span>

<span style=color:#f92672>import</span> (
  <span style=color:#e6db74>&#34;eas/tools/jwt&#34;</span>
  <span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
  <span style=color:#e6db74>&#34;net/url&#34;</span>
  <span style=color:#e6db74>&#34;strings&#34;</span>
)

<span style=color:#75715e>// getTokenString ä» Request Header ä¸­çš„ Authorization è·å– JWTï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™ä» Query Params ä¸­è·å–ã€‚
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getTokenString</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>string</span> {
  <span style=color:#a6e22e>tokenString</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>)
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tokenString</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
    <span style=color:#a6e22e>queryParamsToken</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;token&#34;</span>)

    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>

    <span style=color:#a6e22e>tokenString</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>QueryUnescape</span>(<span style=color:#a6e22e>queryParamsToken</span>)
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
    }
  }

  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>tokenString</span>
}

<span style=color:#75715e>// JWT è®¤è¯ä¸­é—´ä»¶
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>JWT</span>() <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>HandlerFunc</span> {
  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
    <span style=color:#a6e22e>tokenString</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getTokenString</span>(<span style=color:#a6e22e>c</span>)
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tokenString</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
      <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>AbortWithStatusJSON</span>(<span style=color:#ae81ff>401</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
        <span style=color:#e6db74>&#34;status&#34;</span>:  <span style=color:#ae81ff>1</span>,
        <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;è¯·é™„å¸¦ jwt åœ¨ Request Headers[Authorization] æˆ– Query Params[token] å†…&#34;</span>,
        <span style=color:#e6db74>&#34;data&#34;</span>:    <span style=color:#66d9ef>nil</span>,
      })

      <span style=color:#66d9ef>return</span>
    }

    <span style=color:#a6e22e>tokenStringSlice</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>tokenString</span>, <span style=color:#e6db74>&#34; &#34;</span>)
    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>tokenStringSlice</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span> {
      <span style=color:#a6e22e>tokenString</span> = <span style=color:#a6e22e>tokenStringSlice</span>[len(<span style=color:#a6e22e>tokenStringSlice</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
    }

    <span style=color:#a6e22e>claims</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>ParseTokenWithMapClaims</span>(<span style=color:#a6e22e>tokenString</span>)
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
      <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>AbortWithStatusJSON</span>(<span style=color:#ae81ff>401</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
        <span style=color:#e6db74>&#34;status&#34;</span>:  <span style=color:#ae81ff>2</span>,
        <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;éæ³•çš„ token&#34;</span>,
        <span style=color:#e6db74>&#34;data&#34;</span>:    <span style=color:#66d9ef>nil</span>,
      })

      <span style=color:#66d9ef>return</span>
    }

    <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>claims</span>)[<span style=color:#e6db74>&#34;username&#34;</span>].(<span style=color:#66d9ef>string</span>)
    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
      <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>AbortWithStatusJSON</span>(<span style=color:#ae81ff>401</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
        <span style=color:#e6db74>&#34;status&#34;</span>:  <span style=color:#ae81ff>3</span>,
        <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;éæ³•çš„ payload&#34;</span>,
        <span style=color:#e6db74>&#34;data&#34;</span>:    <span style=color:#66d9ef>nil</span>,
      })

      <span style=color:#66d9ef>return</span>
    }

    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;username&#34;</span>, <span style=color:#a6e22e>username</span>)
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Next</span>()
  }
}
</code></pre></div><p>d. å°†è§£æå‡ºæ¥çš„æ•°æ®æ·»åŠ åˆ°çº¦å®šçš„ Response Headers ä¸­ã€‚</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>auth</span>

<span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Auth</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>username</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>GetString</span>(<span style=color:#e6db74>&#34;username&#34;</span>); <span style=color:#a6e22e>username</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>401</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
      <span style=color:#e6db74>&#34;status&#34;</span>:  <span style=color:#ae81ff>1</span>,
      <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;ç”¨æˆ·æœªè®¤è¯&#34;</span>,
      <span style=color:#e6db74>&#34;data&#34;</span>:    <span style=color:#66d9ef>nil</span>,
    })
  } <span style=color:#66d9ef>else</span> {
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Writer</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Username&#34;</span>, <span style=color:#a6e22e>username</span>)
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
      <span style=color:#e6db74>&#34;status&#34;</span>:  <span style=color:#ae81ff>0</span>,
      <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;èº«ä»½è®¤è¯æˆåŠŸ&#34;</span>,
      <span style=color:#e6db74>&#34;data&#34;</span>:    <span style=color:#66d9ef>nil</span>,
    })
  }
}
</code></pre></div><h4 id=2-ç¼–å†™-auth-client>(2) ç¼–å†™ Auth Client<a href=#2-ç¼–å†™-auth-client class=hanchor arialabel=Anchor>&#8983;</a> </h4>
<p>a. å…ˆçœ‹è·¯ç”±å®šä¹‰ï¼ˆä½¿ç”¨ <code>Gin</code>ï¼‰ï¼Œ<code>/api/v1/greeting</code> å°†æ ¹æ®å¤–éƒ¨è®¤è¯ç»“æœæ¥è¿”å›ã€‚</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>router</span>

<span style=color:#f92672>import</span> (
  <span style=color:#e6db74>&#34;eac/internal/api/greeter&#34;</span>
  <span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
)

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>GinRouter</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Engine</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
  <span style=color:#a6e22e>GinRouter</span> = <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Default</span>()

  <span style=color:#a6e22e>apiV1</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GinRouter</span>.<span style=color:#a6e22e>Group</span>(<span style=color:#e6db74>&#34;/api/v1&#34;</span>)
  {
    <span style=color:#a6e22e>apiV1</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/greeting&#34;</span>, <span style=color:#a6e22e>greeter</span>.<span style=color:#a6e22e>Greeting</span>)
  }
}
</code></pre></div><p>b. <code>/api/v1/greeting</code> å…·ä½“å®ç°ã€‚</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>greeter</span>

<span style=color:#f92672>import</span> (
  <span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Greeting</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>username</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>GetHeader</span>(<span style=color:#e6db74>&#34;Username&#34;</span>); <span style=color:#a6e22e>username</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>400</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
      <span style=color:#e6db74>&#34;status&#34;</span>:  <span style=color:#ae81ff>1</span>,
      <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;è·å– Request Headers Username å¤±è´¥&#34;</span>,
      <span style=color:#e6db74>&#34;data&#34;</span>:    <span style=color:#66d9ef>nil</span>,
    })
  } <span style=color:#66d9ef>else</span> {
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
      <span style=color:#e6db74>&#34;status&#34;</span>:  <span style=color:#ae81ff>0</span>,
      <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;Welcome, &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>username</span>,
      <span style=color:#e6db74>&#34;data&#34;</span>:    <span style=color:#66d9ef>nil</span>,
    })
  }
}  
</code></pre></div><h4 id=3-éƒ¨ç½²-rancher-å·¥ä½œè´Ÿè½½>(3) éƒ¨ç½² Rancher å·¥ä½œè´Ÿè½½<a href=#3-éƒ¨ç½²-rancher-å·¥ä½œè´Ÿè½½ class=hanchor arialabel=Anchor>&#8983;</a> </h4>
<p>a. Auth Server</p>
<p><img src=/images/eas-workload.png alt="Auth Server"></p>
<p>b. Auth Client</p>
<p><img src=/images/eac-workload.png alt="Auth Client"></p>
<h4 id=4-é…ç½®-ingress-rancher-è´Ÿè½½å‡è¡¡>(4) é…ç½® Ingress (Rancher è´Ÿè½½å‡è¡¡)<a href=#4-é…ç½®-ingress-rancher-è´Ÿè½½å‡è¡¡ class=hanchor arialabel=Anchor>&#8983;</a> </h4>
<p>a. Auth Server</p>
<p><img src=/images/eas-ingress.png alt="Auth Server"></p>
<p>b. Auth Client</p>
<p>ğŸŒŸ åœ¨ Auth Client çš„ Ingress é…ç½®ä¸­æ·»åŠ å¦‚ä¸‹æ³¨é‡Šã€‚</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>nginx.ingress.kubernetes.io/auth-response-headers</span>: <span style=color:#ae81ff>Username</span>
<span style=color:#f92672>nginx.ingress.kubernetes.io/auth-url</span>: <span style=color:#ae81ff>https://eas.example.com/api/v1/auth</span>
</code></pre></div><p><img src=/images/eac-ingress.png alt="Auth Clinet"></p>
<h4 id=5-æµ‹è¯•>(5) æµ‹è¯•<a href=#5-æµ‹è¯• class=hanchor arialabel=Anchor>&#8983;</a> </h4>
<p>a. è·å– token</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl --location --request GET <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span><span style=color:#e6db74>&#39;https://eas.example.com/api/v1/token?username=6109119115&amp;password=123&#39;</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;data&#34;</span>: {
      <span style=color:#f92672>&#34;token&#34;</span>: <span style=color:#e6db74>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2Mjc3NDgxOTQsInVzZXJuYW1lIjoiNjEwOTExOTExNSJ9.zTynNcdUjWnbGXsCs1lZZsVhMpwiUaz6NBYsW9jK41A&#34;</span>
  },
  <span style=color:#f92672>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;è·å– token æˆåŠŸ&#34;</span>,
  <span style=color:#f92672>&#34;status&#34;</span>: <span style=color:#ae81ff>0</span>
}
</code></pre></div><p>b. éªŒè¯ Auth Server ä½œç”¨</p>
<p>é™„å¸¦ JWT</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl --location --request GET <span style=color:#e6db74>&#39;https://eac.example.com/api/v1/greeting&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--header <span style=color:#e6db74>&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2Mjc3NDgxOTQsInVzZXJuYW1lIjoiNjEwOTExOTExNSJ9.zTynNcdUjWnbGXsCs1lZZsVhMpwiUaz6NBYsW9jK41A&#39;</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;data&#34;</span>: <span style=color:#66d9ef>null</span>,
  <span style=color:#f92672>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;Welcome, 6109119115&#34;</span>,
  <span style=color:#f92672>&#34;status&#34;</span>: <span style=color:#ae81ff>0</span>
}
</code></pre></div><p>æœªé™„å¸¦ JWT</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl --location --request GET <span style=color:#e6db74>&#39;https://eac.example.com/api/v1/greeting&#39;</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>html</span>&gt;

&lt;<span style=color:#f92672>head</span>&gt;
  &lt;<span style=color:#f92672>title</span>&gt;500 Internal Server Error&lt;/<span style=color:#f92672>title</span>&gt;
&lt;/<span style=color:#f92672>head</span>&gt;

&lt;<span style=color:#f92672>body</span>&gt;
  &lt;<span style=color:#f92672>center</span>&gt;
    &lt;<span style=color:#f92672>h1</span>&gt;500 Internal Server Error&lt;/<span style=color:#f92672>h1</span>&gt;
  &lt;/<span style=color:#f92672>center</span>&gt;
  &lt;<span style=color:#f92672>hr</span>&gt;
  &lt;<span style=color:#f92672>center</span>&gt;nginx&lt;/<span style=color:#f92672>center</span>&gt;
&lt;/<span style=color:#f92672>body</span>&gt;

&lt;/<span style=color:#f92672>html</span>&gt;
</code></pre></div>
</div></div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user">
<span>Â© 2021 Powered By Hsinyv Ku :: <a href=https://beian.miit.gov.cn/ target=_blank>èµ£ICPå¤‡20002368å·-1</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
<div class=footer__inner>
<span></span>
<span></span>
<span id=busuanzi_container_site_pv>
æœ¬ç«™è®¿é—®é‡ä¸º <span id=busuanzi_value_site_pv></span> æ¬¡
</span>
<span id=busuanzi_container_site_uv>
æ‚¨æ˜¯æœ¬ç«™ç¬¬ <span id=busuanzi_value_site_uv></span> ä½è®¿é—®è€…
</span>
<span></span>
<span></span>
</div>
</footer>
<script src=https://blog.gxy.ink/assets/main.js></script>
<script src=https://blog.gxy.ink/assets/prism.js></script>
</div>
</body>
</html>